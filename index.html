<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pradiksha Restro Soft</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 10px;
      justify-content: center;
    }
    .bill-preview, .bill-controls {
      flex: 1 1 320px;
      max-width: 480px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 14px;
    }
    input, select, button {
      padding: 8px;
      margin-top: 6px;
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
    }
    #reportViewer, #kotLogViewer {
      display: none;
      margin-top: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 13px;
    }
.main-container { display: flex; flex-wrap: wrap; padding: 10px; }
.left-panel, .right-panel { flex: 1; min-width: 150px; padding: 10px; }
    .logout { background: #fff; color: #ff9800; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .section { margin-bottom: 20px; border: 1px solid #ddd; padding: 10px; border-radius: 6px; }
.qr-code { text-align: center; margin-top: 10px; }
    .qr-code img { width: 80px; height: auto; margin: 0 auto; display: block; }
    .qr-label { font-size: 0.75em; margin-top: 5px; text-align: center; }
    .no-print { display: block; }
   @media print {
  body {
    margin: 0;
    padding: 0;
    width: 210px; /* ~3 inch in pixels */
  }
 #billTable, .no-print, input, select, button {
    display: none !important;
  }

  #printTable {
    display: table !important;
  }
  .app-header,
  .right-panel,
  .no-print,
  input,
  select,
  button {
    display: none !important;
  }

  #printSection {
    width: 203px;
    font-size: 10px;
    margin: 0 auto;
    padding: 0;
  }

  th, td {
    padding: 2px;
    border: none;
    font-size: 10px;
    text-align: left;
  }

  h2, p {
    font-size: 10px;
    margin: 0;
    padding: 0;
  }

  .qr-code img {
    width: 100px;
    margin: 0 auto;
    display: block;
  }

  .qr-label {
    font-size: 8px;
    text-align: center;
  }
.bill-preview {
  width: 280px;
  font-size: 12px;
  font-family: Arial, sans-serif;
  margin: auto;
  padding: 10px;
  border: 1px solid #000;
}

.bill-preview h3 {
  font-size: 14px;
  margin: 5px 0;
}

.bill-preview p, .bill-preview div {
  margin: 2px 0;
}
  </style>
</head>
<body>
  <div class="app-header">
    <button id="logoutBtn">Logout</button>
    <span id="userInfo" style="margin-left: 10px;"></span>
  </div>

  <div class="main-container">
    <!-- LEFT PANEL -->
    <div class="left-panel">
      <div class="bill-preview" id="printSection">
        <div style="text-align: center;">
          <img src="logo.png" alt="Panchabyanjan Logo" style="height: 60px; margin-bottom: 5px;">
          <h2 style="text-align:center;">Panchabyanjan Restaurant and Caterer</h2>
          <p style="text-align:center;">86 Tarafdarpara Rd, Kolkata-700151</p>
          <p style="text-align:center;">Contact Us @ 6290300741</p>
          <p style="text-align:center;">email - panchabyanjanrestaurant@gmail.com</p>
<div style="display: flex; justify-content: space-between; font-weight: bold;">
  <div>Bill No: <span id="billNumber">---</span></div>
  <div>KOT No: <span id="kotNumberDisplay">---</span></div>
</div>
<div style="display: flex; justify-content: space-between; font-weight: bold;">
  <div>Table No: <span id="printTableNumber">---</span></div>
  <div>Date: <span id="printBillTime">---</span></div>
</div>
<div style="text-align:left; font-weight: bold;">
  Customer: <span id="customerDisplay">---</span>
</div>
        </div>
        <table id="billTable">
  <thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead>
  <tbody></tbody>
</table>
          <tbody></tbody>
        </table>
<table id="printTable" style="display: none;">
  <thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead>
  <tbody id="printTableBody"></tbody>
</table>
<pre id="totalsBox" style="text-align:right; font-family: monospace;"></pre>
       
        <p style="margin-top: 10px; font-size: 0.75em; text-align: center;">Thank you for your order!<br>WE ACCEPT PARTY BOOKING</p>
       <div class="qr-code">
          <div class="qr-label">Scan to Pay</div>
          <img src="WhatsApp%20Image%202025-06-23%20at%2012.23.26%20PM.jpeg" alt="UPI QR Code" />
        </div>
      </div>
<div id="reportViewer" style="display:none;" class="no-print section"></div>
<div id="kotLogViewer" style="display:none;" class="no-print section"></div>
      <div class="section no-print" id="reportSection">
        <h3>Reports & Reprint</h3>
        <select id="reprintSelect"></select>
        <button onclick="loadAndPrintBill()">Reprint</button>
        <button onclick="downloadHistoryByDateRangeCSV()">Download Bill History</button>
        <button onclick="downloadItemSalesReportCSV()">Download Item Sales Report</button>
        <button onclick="downloadSettlementReportCSV()">Download Settlement Report</button>
        <button onclick="previewBillHistory()">üîç Preview Bill History</button>
        <button onclick="previewItemSalesReport()">üì¶ Preview Item Sales</button>
        <button onclick="viewKOTLog()">üìë KOT Log</button>
        <button onclick="showManageBillsTab()">üîß Manage Bills</button>
        <button onclick="showManageKOTsTab()">üßæ Manage KOTs</button>
        <button id="saveEditBtn" style="display:none;" onclick="saveEditedBill()">üíæ Save Changes</button>
      </div>
    </div> <!-- END LEFT PANEL -->

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <div class="section" id="billingSection">
        <h3>Generate Bill</h3>
     <label>Customer Mobile</label>
  <input id="customerMobile" autocomplete="off" />
  <div id="customerSuggestions"></div>
        <input type="text" id="customerName" placeholder="Customer Name" />
        <input type="number" id="tableNumber" placeholder="Enter Table No" required />
        <input type="number" id="tax" placeholder="Tax % (optional)" />
        <input type="text" id="menuSearch" placeholder="Search menu..." oninput="filterMenu()" />
<div id="menuSuggestions" style="position:absolute; background:#fff; border:1px solid #ccc; max-height:150px; overflow:auto; display:none; z-index:10;"></div>
        <button onclick="addSpecialItem()">Add Special Item</button>
        <button onclick="generateBill()">Generate Bill</button>
        <button onclick="printAndReset()">Print Bill</button>
      </div>

      <div class="section" id="settlementSection">
        <h3>Settle a Bill</h3>
        <select id="billSelect"></select>
        <select id="settleMode">
          <option value="">Payment Mode</option>
          <option value="Cash">Cash</option>
          <option value="UPI">UPI</option>
          <option value="Card">Card</option>
        </select>
        <input type="text" id="txnId" placeholder="Transaction ID (optional)" />
        <button onclick="settleSelectedBill()">Confirm Settlement</button>
        <button onclick="resetSettlement()">Re-Settle</button>
      </div>

      <div class="section no-print" id="kotLogSection" style="display:none">
        <h3>KOT Log</h3>
        <div id="kotLogContainer"></div>
      </div>

      <div class="section no-print" id="manageBillsTab" style="display:none">
        <h3>Manage Bills</h3>
        <div id="billManager"></div>
      </div>

      <div class="section no-print" id="manageKOTsTab" style="display:none">
        <h3>Manage KOTs</h3>
        <div id="kotManager"></div>
      </div>
    </div> <!-- END RIGHT PANEL -->
  </div> <!-- END MAIN CONTAINER -->
<!-- Menu Type and Rate Modal -->
<div id="typeRateModal" style="display: none; position: fixed; top: 0; left: 0;
  width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000;">
  <div style="background: white; width: 300px; margin: 10% auto; padding: 20px; border-radius: 8px;">
    <h3 id="modalItemName">Select Type & Rate</h3>

    <label for="typeSelect">Type:</label>
    <select id="typeSelect" style="width: 100%; margin-bottom: 10px;"></select>

    <label for="rateSelect">Rate:</label>
    <select id="rateSelect" style="width: 100%; margin-bottom: 20px;"></select>

    <input type="number" id="popupQty" value="1" min="1" style="width:100%; margin-bottom: 15px;" placeholder="Quantity" />

    <button onclick="confirmPopupSelection()">Confirm</button>
    <button onclick="closePopup()">Cancel</button>
  </div>
</div>
</body>
<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAhF-4kKOhQ9tLEydd2PZaOcGAZ2o-KulM",
    authDomain: "panchabyanjanbill.firebaseapp.com",
    databaseURL: "https://panchabyanjanbill-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "panchabyanjanbill",
    storageBucket: "panchabyanjanbill.firebasestorage.app",
    messagingSenderId: "829171785169",
    appId: "1:829171785169:web:6e4af32472abf8b92b94f0"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Auth state watcher
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      const uid = user.uid;
      db.ref("userRoles/" + uid).once("value").then(snapshot => {
        const roleData = snapshot.val();
        if (!roleData || !roleData.role) {
          alert("Access denied: No role assigned");
          firebase.auth().signOut();
          window.location.href = "login.html";
        } else {
          // Store user info
          localStorage.setItem("loggedInUser", JSON.stringify({
            uid: uid,
            role: roleData.role
          }));
          // ‚úÖ Proceed as logged in
        }
      }).catch(err => {
        console.error("Error fetching role:", err.message);
        window.location.href = "login.html";
      });
    } else {
      // Not logged in
      window.location.href = "login.html";
    }
  });

  // ‚úÖ Logout button listener
  document.addEventListener("DOMContentLoaded", function () {
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        firebase.auth().signOut().then(() => {
          localStorage.removeItem("loggedInUser");
          window.location.href = "login.html";
        });
      });
    }
  });
document.getElementById("customerMobile").addEventListener("input", function () {
  const input = this.value.trim();
  const suggestionBox = document.getElementById("customerSuggestions");

  if (input.length < 3) {
    suggestionBox.style.display = "none";
    return;
  }

  firebase.database().ref("customers")
    .orderByKey()
    .startAt(input)
    .endAt(input + "\uf8ff")
    .once("value", snapshot => {
      const data = snapshot.val();
      suggestionBox.innerHTML = "";

      if (!data) {
        suggestionBox.style.display = "none";
        return;
      }

      Object.values(data).forEach(customer => {
        const div = document.createElement("div");
        div.textContent = `${customer.name} | ${customer.mobile}`;
        div.onclick = () => {
          document.getElementById("customerName").value = customer.name;
          document.getElementById("customerMobile").value = customer.mobile;
          suggestionBox.style.display = "none";
        };
        suggestionBox.appendChild(div);
      });

      suggestionBox.style.display = "block";
    });
});

// Hide suggestions when clicking outside
document.addEventListener("click", function (e) {
  const box = document.getElementById("customerSuggestions");
  if (box && !box.contains(e.target) && e.target.id !== "customerMobile") {
    box.style.display = "none";
  }
});

</script>
</body>
</html>
<script>
const menuItems = [
  {
    name: "Chicken Pakora",
    rates: { Regular: 120, Special: 100  }
  },
  {
    name: "Chicken Finger",
    rates: { Regular: 120 }
  },
  {
    name: "Fish Fry(Bhetki)",
    rates: { Regular: 180 }
  },
  {
    name: "Fish Finger",
    rates: { Regular: 180, Special: 160 }
  },
  {
    name: "Paneer Pakora",
    rates: { Regular: 120 }
  },
  {
    name: "French Fry",
    rates: { Regular: 120 }
  },
  {
    name: "Fish Finger (Bhetki) - 5pcs",
    rates: { regular: 160 }
  },
  {
    name: "Fish Fry (Bhetki)",
    rates: { regular: 180 }
  },
  {
    name: "Dry Chilli Chicken - 8pcs",
    rates: { regular: 150 }
  },
  {
    name: "Chicken Finger - 6pcs",
    rates: { regular: 120 }
  },
  {
    name: "Chicken Pakora (Boneless) - 6pcs",
    rates: { regular: 100 }
  },
  {
    name: "Paneer Pakora - 6pcs",
    rates: { regular: 120 }
  },
  {
    name: "French Fry",
    rates: { regular: 120 }
  },
  {
    name: "Egg Fried Rice",
    rates: { regular: 100 }
  },
  {
    name: "Chicken Fried Rice",
    rates: { regular: 120 }
  },
  {
    name: "Veg Fried Rice",
    rates: { regular: 80 }
  },
  {
    name: "Egg Chicken Fried Rice",
    rates: { regular: 140 }
  },
  {
    name: "Basanti Polao",
    rates: { regular: 80 }
  },
  {
    name: "Steamed Rice",
    rates: { regular: 70, plain: 50 }
  },
  {
    name: "Chilly Chicken",
    types: ["Chilly Chicken Half", "Chilly Chicken Full"],
    rates: {
      "Chilly Chicken Half": { regular: 100 },
      "Chilly Chicken Full": { regular: 180 }
    }
  },
  {
    name: "Chicken Kasha",
    types: ["2pc", "4pc"],
    rates: {
      "2pc": { regular: 70 },
      "4pc": { regular: 130 }
    }
  },
  {
    name: "Mutton Kasha",
    types: ["2pc", "4pc"],
    rates: {
      "2pc": { regular: 160 },
      "4pc": { regular: 300 }
    }
  },
  {
    name: "Roti",
    rates: { regular: 6 }
  },
  {
    name: "Tawa Paratha",
    rates: { regular: 12 }
  },
  {
    name: "Green Salad",
    rates: { regular: 50 }
  },
  {
    name: "Onion Salad",
    rates: { regular: 30 }
  },
  {
    name: "Luchi",
    rates: { regular: 8 }
  },
  {
    name: "Peas Pulao",
    rates: { regular: 80 }
  },
  {
    name: "Jeera Rice",
    rates: { regular: 80 }
  },
  {
    name: "Veg Sandwich",
    rates: { regular: 70 }
  },
  {
    name: "Chicken Sandwich",
    rates: { regular: 100 }
  },
  {
    name: "Bread Omlette",
    rates: { regular: 40 }
  },
  {
    name: "Veg Maggi",
    rates: { regular: 35 }
  },
  {
    name: "Egg Maggi",
    rates: { regular: 50 }
  },
  {
    name: "Chicken Maggi",
    rates: { regular: 70 }
  },
  {
    name: "Egg/Chicken with Cheese Maggi",
    rates: { regular: 90 }
  }
  // You can keep adding more based on PDF
];
let billItems = [];
let selectedPopupItem = null;
let selectedType = null;
let selectedRateType = null;

function openTypeAndRatePopup(item) {
  selectedPopupItem = item;
  selectedType = null;
  selectedRateType = null;

  document.getElementById("modalItemName").innerText = `Item: ${item.name}`;

  const typeBox = document.getElementById("typeSelect");
  const rateBox = document.getElementById("rateSelect");
  const qtyInput = document.getElementById("popupQty");

  typeBox.innerHTML = "";
  rateBox.innerHTML = "";
  qtyInput.value = 1;

  // Populate type options if available
  if (item.types && item.types.length) {
    item.types.forEach(type => {
      const option = document.createElement("option");
      option.value = type;
      option.innerText = type;
      typeBox.appendChild(option);
    });
    typeBox.style.display = "block";
  } else {
    const option = document.createElement("option");
    option.value = item.name;
    option.innerText = item.name;
    typeBox.appendChild(option);
    typeBox.style.display = "none";
  }

  // Populate rate options
  const sampleKey = item.types ? item.types[0] : item.name;
  const availableRates = item.rates[sampleKey] || item.rates;

  Object.keys(availableRates).forEach(rateType => {
    const option = document.createElement("option");
    option.value = rateType;
    option.innerText = `${rateType} - ‚Çπ${availableRates[rateType]}`;
    rateBox.appendChild(option);
  });

  document.getElementById("typeRateModal").style.display = "block";
}

function closePopup() {
  document.getElementById("typeRateModal").style.display = "none";
  selectedPopupItem = null;
}

function confirmPopupSelection() {
  const selectedType = document.getElementById("typeSelect").value;
  const selectedRateType = document.getElementById("rateSelect").value;
  const qty = parseInt(document.getElementById("popupQty").value) || 1;

  if (!selectedType || !selectedRateType || !qty) {
    alert("Please select type, rate, and quantity.");
    return;
  }

  const price = selectedPopupItem.rates[selectedType]
    ? selectedPopupItem.rates[selectedType][selectedRateType]
    : selectedPopupItem.rates[selectedRateType];

  if (!price) {
    alert("Invalid rate selected.");
    return;
  }

  billItems.push({ name: selectedType, qty, rate: price });
  renderBill();
  closePopup();
}
function filterMenu() {
  const searchTerm = document.getElementById("menuSearch").value.toLowerCase();
  const resultsBox = document.getElementById("menuSuggestions");
  resultsBox.innerHTML = "";

  if (!searchTerm) {
    resultsBox.style.display = "none";
    return;
  }

  const matchedItems = menuItems.filter(item =>
    item.name.toLowerCase().includes(searchTerm)
  );

  matchedItems.forEach(item => {
    const div = document.createElement("div");
    div.textContent = item.name;
    div.onclick = () => {
      resultsBox.style.display = "none";
      openTypeAndRatePopup(item); // assuming this function exists
    };
    resultsBox.appendChild(div);
  });

  resultsBox.style.display = matchedItems.length ? "block" : "none";
}

function addItem() {
  if (!window.preparedItem) {
    return alert("Please select item and confirm type/rate first.");
  }

  const qty = parseInt(document.getElementById("qty").value) || 1;
  billItems.push({ name: window.preparedItem.name, qty, rate: window.preparedItem.rate });

  window.preparedItem = null; // Reset
  renderBill();
}

function addSpecialItem() {
  const name = prompt("Enter item name:");
  const rate = parseFloat(prompt("Enter rate:"));
  const qty = parseInt(prompt("Enter qty:"));
  if (!name || !rate || !qty) return;
  billItems.push({ name, qty, rate });
  renderBill();
}

function renderBill() {
  const tbody = document.querySelector("#billTable tbody");
  tbody.innerHTML = "";

  const printBody = document.getElementById("printTableBody");
  if (printBody) printBody.innerHTML = "";

  let subtotal = 0;

  billItems.forEach(({ name, qty, rate }, index) => {
    const qtySafe = isNaN(qty) ? 1 : qty;
    const rateSafe = isNaN(rate) ? 0 : rate;
    const total = qtySafe * rateSafe;
    subtotal += total;

    // Editable bill table
    tbody.innerHTML += `
      <tr>
        <td>${name}</td>
        <td>
          <input type="number" value="${qtySafe}" min="1" style="width: 50px;"
                 onchange="updateItemQty(${index}, this.value)" />
        </td>
        <td>${rateSafe}</td>
        <td>${total.toFixed(2)}</td>
        <td><button onclick="removeItem(${index})">‚ùå</button></td>
      </tr>
    `;

    // Print-only version
    if (printBody) {
      printBody.innerHTML += `
        <tr>
          <td>${name}</td>
          <td>${qtySafe}</td>
          <td>${rateSafe}</td>
          <td>${total.toFixed(2)}</td>
        </tr>
      `;
    }
  });

  const tax = parseFloat(document.getElementById("tax").value) || 0;
  const taxAmt = subtotal * tax / 100;
  const total = subtotal + taxAmt;

  // Monospaced aligned totals
  function formatLine(label, value) {
    const labelPad = label.padEnd(10, ' ');
    const valueStr = `‚Çπ${value.toFixed(2).padStart(7, ' ')}`;
    return `${labelPad}: ${valueStr}`;
  }

  document.getElementById("totalsBox").innerText =
    formatLine("Subtotal", subtotal) + "\n" +
    formatLine("Tax", taxAmt) + "\n" +
    formatLine("Total", total);

  // Optional: populate hidden print totals if needed
  const printSubtotal = document.getElementById("printSubtotal");
  const printTax = document.getElementById("printTax");
  const printTotal = document.getElementById("printTotal");

  if (printSubtotal) printSubtotal.innerText = subtotal.toFixed(2);
  if (printTax) printTax.innerText = taxAmt.toFixed(2);
  if (printTotal) printTotal.innerText = total.toFixed(2);
}

function updateItemQty(index, newQty) {
  const qty = parseInt(newQty);
  if (!qty || qty < 1) return;
  billItems[index].qty = qty;
  renderBill();
}

function removeItem(index) {
  if (confirm("Remove this item?")) {
    billItems.splice(index, 1);
    renderBill();
  }
}
function generateBill() {
  const name = document.getElementById("customerName").value.trim();
  const mobile = document.getElementById("customerMobile").value.trim();
  const tableNo = document.getElementById("tableNumber").value.trim();
  const taxRate = parseFloat(document.getElementById("tax").value) || 0;

  if (!name || !mobile) {
    alert("Customer name and mobile are required.");
    return;
  }

  if (!tableNo) {
    alert("Table number is required.");
    return;
  }

  // Get new Bill No via Firebase transaction
  db.ref("lastBillNo").transaction(current => (current || 1000) + 1)
    .then(res => {
      const billNo = "PB/25-26/" + res.snapshot.val();
      const createdAt = new Date().toISOString();

      // Save customer
      db.ref("customers/" + mobile).set({ name, mobile });

      // Display info (safe element access)
      const billNumberEl = document.getElementById("billNumber");
      if (billNumberEl) billNumberEl.innerText = billNo;

      const customerDisplayEl = document.getElementById("customerDisplay");
      if (customerDisplayEl) customerDisplayEl.innerText = `${name} | ${mobile}`;

      const tableEl = document.getElementById("printTableNumber");
      if (tableEl) tableEl.innerText = tableNo;

      const dateEl = document.getElementById("printBillTime");
      if (dateEl) dateEl.innerText = new Date().toLocaleString();

      // Calculate totals
      let subtotal = 0;
      const items = billItems.map(item => {
        const lineTotal = item.qty * item.rate;
        subtotal += lineTotal;
        return `${item.name} (x${item.qty}) = ‚Çπ${lineTotal.toFixed(2)}`;
      });

      const taxAmount = subtotal * (taxRate / 100);
      const total = subtotal + taxAmount;

      const subtotalEl = document.getElementById("subtotal");
      if (subtotalEl) subtotalEl.innerText = subtotal.toFixed(2);

      const taxEl = document.getElementById("taxAmount");
      if (taxEl) taxEl.innerText = taxAmount.toFixed(2);

      const totalEl = document.getElementById("grandTotal");
      if (totalEl) totalEl.innerText = total.toFixed(2);

      // Save bill
      const billData = {
        billNo,
        name,
        mobile,
        tableNo,
        items,
        subtotal: parseFloat(subtotal.toFixed(2)),
        tax: parseFloat(taxAmount.toFixed(2)),
        total: parseFloat(total.toFixed(2)),
        createdAt,
        paymentMode: "Unpaid"
      };

      const billRef = db.ref("bills").push();
      billRef.set(billData);

      // Generate KOT
      generateKOT(billNo, items, tableNo);
    })
    .catch(error => {
      console.error("Failed to generate bill number:", error);
      alert("‚ùå Error generating bill number. Please try again.");
    });
}
function saveAndStoreBill(billNo, name, mobile, tableNo) {
  const tax = parseFloat(document.getElementById("tax").value) || 0;
  let subtotal = 0;

  const items = billItems
    .filter(i => !isNaN(i.qty) && i.qty > 0 && !isNaN(i.rate))
    .map(i => {
      const total = i.qty * i.rate;
      subtotal += total;
      return `${i.name} (x${i.qty}) = ‚Çπ${total.toFixed(2)}`;
    });

  const taxAmt = subtotal * tax / 100;
  const grandTotal = subtotal + taxAmt;

  const bill = {
    billNo,
    date: new Date().toISOString(),
    name,
    mobile,
    tableNo,
    items,
    subtotal,
    tax: taxAmt,
    total: grandTotal,
    paymentMode: "Unpaid"
  };

  const history = JSON.parse(localStorage.getItem("billHistory") || "[]");
  history.push(bill);
  localStorage.setItem("billHistory", JSON.stringify(history));

  db.ref("bills").push(bill);
  generateKOT(billNo, items, tableNo);
  showSettlementTab(); 
}

function generateKOT(billNo, items, tableNo) {
  db.ref("lastKOTNo").transaction(curr => (curr || 2000) + 1).then(res => {
    const kotNo = res.snapshot.val();

    const kot = {
      kotNo,
      billNo,
      tableNo,
      items,
      createdAt: new Date().toISOString()
    };

    db.ref("kots").push(kot);
    document.getElementById("kotNumberDisplay").innerText = kotNo;

    // Build KOT print content
    const itemLines = items.map(i => {
      const match = i.match(/^(.*?) \(x(\d+)\)/);
      return match ? `‚Ä¢ ${match[1]}  x${match[2]}` : `‚Ä¢ ${i}`;
    });

    const kotHTML = `
      <div style="width: 203px; font-size: 10px; font-family: monospace;">
        <h3 style="text-align:center;">Panchabyanjan Restaurant and Caterer</h3>
        <h3 style="text-align:center;">KOT</h3>
        <p>KOT No: ${kotNo}</p>
        <p>Bill No: ${billNo}</p>
        <p>Table No: ${tableNo}</p>
        <hr />
        <pre>${itemLines.join("\n")}</pre>
        <hr />
        <p style="text-align:center;">Kitchen Copy</p>
      </div>
    `;

    const win = window.open("", "_blank");
    win.document.write(kotHTML);
    win.document.close();
    win.focus();
    win.print();
  });
}
function generateUpdatedKOT(billNo, items, tableNo) {
  if (!tableNo) {
    alert("Table number is required to update KOT.");
    return;
  }

  const kotId = "KOT" + Date.now();

  db.ref("lastKOTNo").transaction(current => (current || 2000) + 1).then(res => {
    const kotNo = res.snapshot.val();

    const kot = {
      kotId,
      kotNo,
      tableNo,
      billNo,
      items,
      createdAt: new Date().toISOString(),
      updated: true
    };

    db.ref("kots").push(kot);
    document.getElementById("kotNumberDisplay").innerText = kotNo;

    const itemLines = items.map(i => {
      const match = i.match(/^(.*?) \(x(\d+)\)/);
      return match ? `‚Ä¢ ${match[1]}  x${match[2]}` : `‚Ä¢ ${i}`;
    });

    const kotHTML = `
      <div style="width: 203px; font-size: 10px; font-family: monospace;">
        <h3 style="text-align:center;">Panchabyanjan Restaurant and Caterer</h3>
        <h3 style="text-align:center;">UPDATED KOT</h3>
        <p>KOT No: ${kotNo}</p>
        <p>Bill No: ${billNo}</p>
        <p>Table No: ${tableNo}</p>
        <hr />
        <pre>${itemLines.join("\n")}</pre>
        <hr />
        <p style="text-align:center;">Updated Kitchen Copy</p>
      </div>
    `;

    const win = window.open("", "_blank");
    win.document.write(kotHTML);
    win.document.close();
    win.focus();
    win.print();
  }).catch(err => {
    console.error("Failed to update KOT:", err);
    alert("Error updating KOT. Please try again.");
  });
}
function printAndReset() {
  window.onafterprint = () => {
    billItems.length = 0;

    const resetValue = id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    };

    const resetText = id => {
      const el = document.getElementById(id);
      if (el) el.innerText = "---";
    };

    resetValue("customerName");
    resetValue("customerMobile");
    resetValue("tax");
    resetValue("menuSearch");
    resetValue("qty");

    resetText("billNumber");
    resetText("customerDisplay");
    resetText("printTableNumber");
    resetText("printBillTime");

    const totalsBox = document.getElementById("totalsBox");
    if (totalsBox) totalsBox.innerText = "";

    const tbody = document.querySelector("#billTable tbody");
    if (tbody) tbody.innerHTML = "";

    const printBody = document.getElementById("printTableBody");
    if (printBody) printBody.innerHTML = "";

    if (typeof filterMenu === "function") filterMenu();
    if (typeof populateReprintDropdown === "function") populateReprintDropdown();

    const nameInput = document.getElementById("customerName");
    if (nameInput) nameInput.focus();
  };

  window.print();
}
function populateReprintDropdown() {
  db.ref("bills").once("value", snap => {
    const all = snap.val();
    const select = document.getElementById("reprintSelect");
    select.innerHTML = "<option value=''>Select Bill</option>";
    Object.entries(all || {}).forEach(([key, bill]) => {
      select.innerHTML += `<option value="${key}">#${bill.billNo} - ${bill.name} - ${bill.date?.split("T")[0]}</option>`;
    });
  });
}

function loadAndPrintBill() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  const key = document.getElementById("reprintSelect").value;
  if (!key) return alert("Select a bill to reprint");
  db.ref("bills/" + key).once("value", snap => {
    const bill = snap.val();
    if (!bill) return alert("Bill not found");

    document.getElementById("billNumber").innerText = bill.billNo;
    document.getElementById("customerDisplay").innerText = bill.name + " | " + bill.mobile;

    const tbody = document.querySelector("#billTable tbody");
    tbody.innerHTML = "";
    (bill.items || []).forEach(line => {
      const match = line.match(/^(.*?) \(x(\d+)\) = ‚Çπ(\d+(?:\.\d+)?)/);
      if (match) {
        const name = match[1], qty = match[2], rate = (parseFloat(match[3]) / parseInt(qty)).toFixed(2);
        const total = parseFloat(match[3]);
        tbody.innerHTML += `<tr><td>${name}</td><td>${qty}</td><td>${rate}</td><td>${total}</td></tr>`;
      }
    });

    document.getElementById("subtotal").innerText = bill.subtotal.toFixed(2);
    document.getElementById("taxAmount").innerText = bill.tax.toFixed(2);
    document.getElementById("grandTotal").innerText = bill.total.toFixed(2);

    setTimeout(() => window.print(), 500);
  });
}
function formatDateLocal(isoStr) {
  const d = new Date(isoStr);
  return d.toLocaleString("en-IN", {
    hour12: true,
    day: "2-digit", month: "2-digit", year: "numeric",
    hour: "2-digit", minute: "2-digit"
  });
}
window.onload = function () {
  document.getElementById("menuSearch").addEventListener("input", filterMenu);
  populateReprintDropdown();
  showSettlementTab(); // üîÅ Add this here
};
function saveEditedBill() {
  if (!editingBillKey) return alert("No bill in edit mode.");

  const name = document.getElementById("customerName").value.trim();
  const mobile = document.getElementById("customerMobile").value.trim();
  const tableNo = document.getElementById("tableNumber").value.trim();  // ‚úÖ Fixed
  const billNo = document.getElementById("billNumber").innerText.trim();
  const tax = parseFloat(document.getElementById("tax").value) || 0;

  if (!name || !mobile || !tableNo) {
    alert("Please fill in Customer Name, Mobile, and Table Number.");
    return;
  }

  // Recalculate totals
  let subtotal = 0;
  const items = billItems.map(i => {
    const total = i.qty * i.rate;
    subtotal += total;
    return `${i.name} (x${i.qty}) = ‚Çπ${total.toFixed(2)}`;
  });

  const taxAmt = subtotal * tax / 100;
  const total = subtotal + taxAmt;

  const bill = {
    billNo,
    name,
    mobile,
    tableNo,  // ‚úÖ Make sure it's saved
    items,
    subtotal: parseFloat(subtotal.toFixed(2)),
    tax: parseFloat(taxAmt.toFixed(2)),
    total: parseFloat(total.toFixed(2)),
    paymentMode: "Unpaid",
    updatedAt: new Date().toISOString()
  };

  db.ref("bills/" + editingBillKey).set(bill, (err) => {
    if (err) {
      alert("‚ùå Failed to save changes.");
    } else {
      alert("‚úÖ Bill updated successfully.");
      document.getElementById("saveEditBtn").style.display = "none";
      editingBillKey = null;

      // ‚úÖ Generate UPDATED KOT (replaces old one)
      generateUpdatedKOT(billNo, items, tableNo);
    }
  });

  // üîÅ Optional: Update or create customer record
  const customerKey = mobile;
  const customerObj = {
    name: name,
    mobile: mobile,
    lastVisited: new Date().toISOString()
  };

  db.ref("customers/" + customerKey).set(customerObj);
}

</script>
<script>
// ==== SETTLEMENT ====
function showSettlementTab() {
  const section = document.getElementById("settlementSection");
  if (section) section.style.display = "block";

  db.ref("bills").once("value", snapshot => {
    const allBills = snapshot.val();
    const select = document.getElementById("billSelect");
    if (!select) return;

    select.innerHTML = "<option value=''>Select Bill</option>";

    Object.entries(allBills || {}).forEach(([key, bill]) => {
      if (!bill.paymentMode || bill.paymentMode === "Unpaid") {
        select.innerHTML += `<option value="${key}">Bill#${bill.billNo} - ‚Çπ${bill.total} (${bill.name})</option>`;
      }
    });
  });
}

function settleSelectedBill() {
  const key = document.getElementById("billSelect").value;
  const mode = document.getElementById("settleMode").value;
  const txnId = document.getElementById("txnId").value;
  if (!key || !mode) return alert("Select bill and mode");
  db.ref("bills/" + key).update({ paymentMode: mode, transactionId: txnId || "" }, err => {
    if (err) alert("Error saving settlement");
    else {
      alert("Settlement saved");
      showSettlementTab();
    }
  });
}

// ==== CSV EXPORT ====
function downloadCSV(data, filename) {
  const csv = data.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

function downloadHistoryByDateRangeCSV() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  const from = prompt("From date (YYYY-MM-DD)");
  const to = prompt("To date (YYYY-MM-DD)");
  db.ref("bills").once("value", snap => {
    const all = snap.val();
    const rows = [["Bill No", "Date", "Time","Customer", "Mobile", "Total"]];
    Object.values(all || {}).forEach(b => {
      const d = b.date?.split("T")[0];
      if (d >= from && d <= to) {
        rows.push([b.billNo, formatDateLocal(b.date), b.name, b.mobile, b.total]);
      }
    });
    downloadCSV(rows, `bill_history_${from}_to_${to}.csv`);
  });
}

function downloadItemSalesReportCSV() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  const from = prompt("From date (YYYY-MM-DD)");
  const to = prompt("To date (YYYY-MM-DD)");
  db.ref("bills").once("value", snap => {
    const all = snap.val();
    const itemsMap = {};
    Object.values(all || {}).forEach(b => {
      const d = b.date?.split("T")[0];
      if (d >= from && d <= to) {
        (b.items || []).forEach(line => {
          const match = line.match(/^(.*?) \(x(\d+)\) = ‚Çπ(\d+(\.\d+)?)/);
          if (match) {
            const name = match[1];
            const qty = parseInt(match[2]);
if (isNaN(qty) || qty < 1) return console.warn("Invalid qty:", match[2]);
            const amt = parseFloat(match[3]);
            if (!itemsMap[name]) itemsMap[name] = { qty: 0, amt: 0 };
            itemsMap[name].qty += qty;
            itemsMap[name].amt += amt;
          }
        });
      }
    });
    const rows = [["Item", "Quantity", "Amount"]];
    Object.entries(itemsMap).forEach(([name, { qty, amt }]) => {
      rows.push([name, qty, amt.toFixed(2)]);
    });
    downloadCSV(rows, `item_sales_${from}_to_${to}.csv`);
  });
}

function downloadSettlementReportCSV() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  const from = prompt("From date (YYYY-MM-DD)");
  const to = prompt("To date (YYYY-MM-DD)");
  db.ref("bills").once("value", snapshot => {
    const allBills = snapshot.val();
    if (!allBills) return alert("No bills found");

    const rows = [["Bill No", "Date", "Time","Customer", "Total", "Payment Mode", "Transaction ID"]];
    const summary = { Cash: 0, UPI: 0, Card: 0 };
    let totalSettled = 0;

    Object.values(allBills).forEach(b => {
      const date = b.date?.split("T")[0];
      if (date >= from && date <= to && b.paymentMode && b.paymentMode !== "Unpaid") {
        const mode = b.paymentMode;
        const amt = parseFloat(b.total) || 0;
        if (summary[mode] !== undefined) summary[mode] += amt;
        totalSettled += amt;
        rows.push([b.billNo, formatDateLocal(b.date), b.name, amt.toFixed(2), mode, b.transactionId || ""]);
      }
    });

    rows.push([], ["Summary"]);
    Object.entries(summary).forEach(([k, v]) => rows.push([k, v.toFixed(2)]));
    rows.push(["Total Settled", totalSettled.toFixed(2)]);
    downloadCSV(rows, `settlement_report_${from}_to_${to}.csv`);
  });
}

// ==== PREVIEW REPORTS ====
function previewBillHistory() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  const from = prompt("From date (YYYY-MM-DD)");
  const to = prompt("To date (YYYY-MM-DD)");
  db.ref("bills").once("value", snap => {
    const all = snap.val();
    const rows = [["Bill No", "Date", "Customer", "Mobile", "Total"]];
    Object.values(all || {}).forEach(b => {
      const d = b.date?.split("T")[0];
      if (d >= from && d <= to) {
        rows.push([b.billNo, b.date, b.name, b.mobile, b.total]);
      }
    });
    displayInViewer(rows, "Bill History Report");
  });
}

function previewItemSalesReport() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  const from = prompt("From date (YYYY-MM-DD)");
  const to = prompt("To date (YYYY-MM-DD)");
  db.ref("bills").once("value", snap => {
    const all = snap.val();
    const itemsMap = {};
    Object.values(all || {}).forEach(b => {
      const d = b.date?.split("T")[0];
      if (d >= from && d <= to) {
        (b.items || []).forEach(line => {
          const match = line.match(/^(.*?) \(x(\d+)\) = ‚Çπ(\d+(\.\d+)?)/);
          if (match) {
            const name = match[1];
            const qty = parseInt(match[2]);
if (isNaN(qty) || qty < 1) return console.warn("Invalid qty:", match[2]);
            const amt = parseFloat(match[3]);
            if (!itemsMap[name]) itemsMap[name] = { qty: 0, amt: 0 };
            itemsMap[name].qty += qty;
            itemsMap[name].amt += amt;
          }
        });
      }
    });
    const rows = [["Item", "Quantity", "Amount"]];
    Object.entries(itemsMap).forEach(([name, { qty, amt }]) => {
      rows.push([name, qty, amt.toFixed(2)]);
    });
    displayInViewer(rows, "Item Sales Report");
  });
}

function displayInViewer(rows, title) {
  const container = document.getElementById("reportViewer");
  container.innerHTML = `<h3>${title}</h3>`;
  const table = document.createElement("table");
  table.innerHTML = rows.map((r, i) =>
    `<tr>${r.map(col =>
      `<${i === 0 ? "th" : "td"}>${col}</${i === 0 ? "th" : "td"}>`).join("")
    }</tr>`
  ).join("");
  container.appendChild(table);
  container.style.display = "block";
}

// ==== KOT LOG ====
function viewKOTLog() {
  const from = prompt("From date (YYYY-MM-DD)");
  const to = prompt("To date (YYYY-MM-DD)");
  db.ref("kots").once("value", snap => {
    const all = snap.val();
    const rows = [["KOT No", "Bill No", "Items", "Created"]];
    Object.values(all || {}).forEach(k => {
      const d = k.createdAt?.split("T")[0];
      if (d >= from && d <= to) {
        rows.push([k.kotNo, k.billNo, (k.items || []).join(" / "), k.createdAt]);
      }
    });
    const viewer = document.getElementById("kotLogViewer");
    viewer.innerHTML = `<h3>KOT Log</h3>`;
    const table = document.createElement("table");
    table.innerHTML = rows.map((r, i) =>
      `<tr>${r.map(col =>
        `<${i === 0 ? "th" : "td"}>${col}</${i === 0 ? "th" : "td"}>`).join("")
      }</tr>`
    ).join("");
    viewer.appendChild(table);
    viewer.style.display = "block";
  });
}

// ==== ADMIN BILL/KOT MANAGERS ====
function showManageBillsTab() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  document.getElementById("manageBillsTab").style.display = "block";
  document.getElementById("manageKOTsTab").style.display = "none";
  const container = document.getElementById("billManager");
  container.innerHTML = "Loading...";
  db.ref("bills").once("value", snap => {
    const bills = snap.val();
    if (!bills) return container.innerHTML = "No bills found.";

    const table = document.createElement("table");
    table.innerHTML = `<tr><th>Bill No</th><th>Customer</th><th>Total</th><th>Date</th><th>Actions</th></tr>`;
    Object.entries(bills).forEach(([key, bill]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${bill.billNo}</td>
        <td>${bill.name}</td>
        <td>‚Çπ${bill.total}</td>
        <td>${bill.date?.split("T")[0]}</td>
        <td>
          <button onclick="loadBillForEdit('${key}')">Edit</button>
          <button onclick="deleteBill('${key}')">Delete</button>
        </td>
      `;
      table.appendChild(tr);
    });

    container.innerHTML = "";
    container.appendChild(table);
  });
}

function loadBillForEdit(key) {
  db.ref("bills/" + key).once("value", snap => {
    const bill = snap.val();
    if (!bill) return alert("Bill not found");

    editingBillKey = key;
    document.getElementById("saveEditBtn").style.display = "block";

    // Set customer info
    document.getElementById("customerName").value = bill.name || "";
    document.getElementById("customerMobile").value = bill.mobile || "";

    // ‚úÖ Table No fix
    document.getElementById("tableNumber").value = bill.tableNo || "";

    // ‚úÖ Tax rate calculation (avoid NaN)
    if (bill.subtotal && bill.tax) {
      document.getElementById("tax").value = ((bill.tax / bill.subtotal) * 100).toFixed(2);
    } else {
      document.getElementById("tax").value = 0;
    }

    document.getElementById("billNumber").innerText = bill.billNo || "---";
    document.getElementById("customerDisplay").innerText = `${bill.name} | ${bill.mobile}`;

    // Clear and re-build bill items
    billItems.length = 0;
    let anyParsed = false;

    (bill.items || []).forEach(line => {
      const match = line.match(/^(.*?) \(x(\d+)\) = ‚Çπ(\d+(?:\.\d+)?)/);
      if (match) {
        const name = match[1].trim();
        const qty = parseInt(match[2]);
        const total = parseFloat(match[3]);

        if (isNaN(qty) || qty <= 0 || isNaN(total)) {
          console.warn("Invalid item line:", line);
          return;
        }

        const rate = (total / qty).toFixed(2);
        billItems.push({ name, qty, rate: parseFloat(rate) });
        anyParsed = true;
      } else {
        console.warn("‚ö†Ô∏è Could not parse item line:", line);
      }
    });

    if (!anyParsed) {
      alert("‚ö†Ô∏è No items could be loaded. Please check data format.");
      return;
    }

    renderBill();
    alert("‚úÖ Bill loaded. Make changes and click Save.");
  });
}

function deleteBill(key) {
  if (confirm("Delete this bill?")) {
    db.ref("bills/" + key).remove(err => {
      if (err) alert("Error deleting bill");
      else {
        alert("Deleted");
        showManageBillsTab();
      }
    });
  }
}

function showManageKOTsTab() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  document.getElementById("manageKOTsTab").style.display = "block";
  document.getElementById("manageBillsTab").style.display = "none";
  const container = document.getElementById("kotManager");
  container.innerHTML = "Loading...";
  db.ref("kots").once("value", snap => {
    const kots = snap.val();
    if (!kots) return container.innerHTML = "No KOTs found.";

    const table = document.createElement("table");
    table.innerHTML = `<tr><th>KOT No</th><th>Bill No</th><th>Items</th><th>Time</th><th>Actions</th></tr>`;
    Object.entries(kots).forEach(([key, kot]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${kot.kotNo}</td>
        <td>${kot.billNo}</td>
        <td>${(kot.items || []).join(" / ")}</td>
        <td>${kot.createdAt?.split("T")[0]}</td>
        <td><button onclick="deleteKOT('${key}')">Delete</button></td>
      `;
      table.appendChild(tr);
    });

    container.innerHTML = "";
    container.appendChild(table);
  });
}

function deleteKOT(key) {
  if (confirm("Delete this KOT?")) {
    db.ref("kots/" + key).remove(err => {
      if (err) alert("Error deleting KOT");
      else {
        alert("Deleted");
        showManageKOTsTab();
      }
    });
  }
}
function populateSettlementDropdown() {
  const select = document.getElementById("billSelect");
  select.innerHTML = "<option value=''>Select Settled Bill</option>";

  db.ref("bills").once("value", snap => {
    const bills = snap.val() || {};
    Object.entries(bills).forEach(([key, bill]) => {
      if (bill.paymentMode && bill.paymentMode !== "Unpaid") {
        select.innerHTML += `<option value="${key}">#${bill.billNo} - ${bill.name} - ${bill.paymentMode}</option>`;
      }
    });
  });
}
function confirmSettlement() {
  const key = document.getElementById("billSelect").value;
  const mode = document.getElementById("settleMode").value;
  const txnId = document.getElementById("txnId").value;

  if (!key || !mode) return alert("Select a bill and mode");

  db.ref("bills/" + key).once("value", snap => {
    const bill = snap.val();
    if (!bill) return alert("Bill not found");

    bill.paymentMode = mode;
    if (txnId) bill.txnId = txnId;

    db.ref("bills/" + key).set(bill, err => {
      if (err) alert("Failed to update settlement");
      else {
        alert("Settlement updated");
        resetSettlement();
      }
    });
  });
}
function resetSettlement() {
const role = sessionStorage.getItem("role");
if (role === "staff") {
  alert("Access denied");
  return;
}
  document.getElementById("billSelect").value = "";
  document.getElementById("settleMode").value = "";
  document.getElementById("txnId").value = "";
  populateSettlementDropdown(); // üîÅ refresh list after resettle
}
function fixIncompleteBills() {
  const db = firebase.database();
  db.ref("bills").once("value").then(snapshot => {
    const bills = snapshot.val() || {};
    let fixedCount = 0;
    let unchanged = 0;

    const updates = {};

    Object.entries(bills).forEach(([key, bill]) => {
      if (!Array.isArray(bill.items)) return;

      let changed = false;
      let subtotal = 0;

      const newItems = bill.items.map(line => {
        const match = line.match(/^(.*?) \(x(\d+)\) = ‚Çπ(\d+(?:\.\d+)?)/);
        if (!match) return line;

        const name = match[1];
        const qty = parseInt(match[2]);
if (isNaN(qty) || qty < 1) return console.warn("Invalid qty:", match[2]);
        const total = parseFloat(match[3]) || 0;
        subtotal += total;

        return `${name} (x${qty}) = ‚Çπ${(qty * (total / qty)).toFixed(2)}`;
      });

      const fixed = {
        items: newItems,
        subtotal: bill.subtotal ?? subtotal,
        tax: bill.tax ?? 0,
        total: bill.total ?? subtotal,
        paymentMode: bill.paymentMode || "CASH",
        createdAt: bill.createdAt || bill.date || new Date().toISOString(),
        kotNo: bill.kotNo ?? 999
      };

      Object.entries(fixed).forEach(([field, value]) => {
        if (bill[field] === undefined) {
          updates[`bills/${key}/${field}`] = value;
          changed = true;
        }
      });

      if (changed) fixedCount++;
      else unchanged++;
    });

    if (Object.keys(updates).length === 0) {
      alert("No incomplete bills found.");
      return;
    }

    db.ref().update(updates, err => {
      if (err) return alert("Fix failed: " + err.message);
      alert(`‚úÖ Bills fixed: ${fixedCount}\n‚ûñ Bills unchanged: ${unchanged}`);
    });
  });
}
</script>
</html>
